/**
 * @fileoverview Firestore Security Rules for ConnectSphere.
 *
 * Core Philosophy: This ruleset enforces a strict user-ownership model for personal data
 * and role-based access for administrative functions. It prioritizes secure data access
 * by validating user identity and using denormalization to avoid costly `get()` operations.
 *
 * Data Structure:
 * - /users/{userId}: User profile information, accessible only to the owning user.
 * - /users/{userId}/status_updates/{statusId}: Status updates for a specific user,
 *   accessible only to the owning user.
 * - /chat_groups/{groupId}: Group chat information, accessible to members of the group.
 *   Authorization is based on a denormalized `memberIds` array within the document.
 * - /chat_groups/{groupId}/messages/{messageId}: Chat messages within a group, accessible
 *   to members of the group.
 * - /users/{userId}/private_chats/{chatId}/messages/{messageId}: Direct messages between users.
 * - /affiliate_products/{productId}: Affiliate product information, publicly readable but
 *   only modifiable by admins.
 * - /roles_admin/{userId}: Documents that indicate admin role. Existence of document grants admin privileges.
 *
 * Key Security Decisions:
 * - User data is strictly private, with access limited to the owning user.
 * - Listing of all users is disallowed to prevent information harvesting.
 * - Chat group membership is managed through a denormalized `memberIds` array for efficient
 *   authorization.
 * - Affiliate products are publicly readable but only modifiable by admins.
 * - Admin privileges are granted by the existence of a document in the `/roles_admin/{userId}` collection.
 *
 * Denormalization for Authorization:
 * - Chat group membership is denormalized into the `memberIds` array within the
 *   `/chat_groups/{groupId}` document. This avoids the need for costly `get()` operations
 *   to check membership when accessing group chat data.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures user profile data. Only the user with the matching ID can read or write their profile.
     * @path /users/{userId}
     * @allow (create) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can create their profile at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @allow (get) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can get their profile at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @allow (update) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can update their profile at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @allow (delete) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can delete their profile at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @deny (create) User 'someOtherUserId' cannot create a profile at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @deny (get) User 'someOtherUserId' cannot get the profile at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @deny (update) User 'someOtherUserId' cannot update the profile at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @deny (delete) User 'someOtherUserId' cannot delete the profile at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @principle Enforces document ownership for all operations.
     */
    match /users/{userId} {
      // Helper function to check if the request is from the owner.
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Helper function to check if the request is from an existing owner.
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secures status updates for a user. Only the user can read or write their own status updates.
     * @path /users/{userId}/status_updates/{statusId}
     * @allow (create) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can create a status update at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/status_updates/someStatusId.
     * @allow (get) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can get a status update at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/status_updates/someStatusId.
     * @allow (update) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can update a status update at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/status_updates/someStatusId.
     * @allow (delete) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can delete a status update at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/status_updates/someStatusId.
     * @deny (create) User 'someOtherUserId' cannot create a status update at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/status_updates/someStatusId.
     * @deny (get) User 'someOtherUserId' cannot get a status update at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/status_updates/someStatusId.
     * @deny (update) User 'someOtherUserId' cannot update a status update at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/status_updates/someStatusId.
     * @deny (delete) User 'someOtherUserId' cannot delete a status update at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/status_updates/someStatusId.
     * @principle Enforces document ownership and restricts access to user-specific data.
     */
    match /users/{userId}/status_updates/{statusId} {
      // Reuse the isOwner function defined above.
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }

      // Helper function to check if the request is from an existing owner.
      function isExistingOwner(userId) {
        return isOwner(userId) && exists(resource);
      }

      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Secures chat group data. Only members of the group can read or write group information.
     * @path /chat_groups/{groupId}
     * @allow (create) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can create a group at /chat_groups/someGroupId if they are a member.
     * @allow (get) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can get a group at /chat_groups/someGroupId if they are a member.
     * @allow (update) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can update a group at /chat_groups/someGroupId if they are a member.
     * @allow (delete) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can delete a group at /chat_groups/someGroupId if they are a member.
     * @deny (create) User 'someOtherUserId' cannot create a group at /chat_groups/someGroupId if they are not a member.
     * @deny (get) User 'someOtherUserId' cannot get a group at /chat_groups/someGroupId if they are not a member.
     * @deny (update) User 'someOtherUserId' cannot update a group at /chat_groups/someGroupId if they are not a member.
     * @deny (delete) User 'someOtherUserId' cannot delete a group at /chat_groups/someGroupId if they are not a member.
     * @principle Enforces group membership for all operations.  Leverages denormalized 'memberIds' for authorization.
     */
    match /chat_groups/{groupId} {
      // Helper function to check if the user is a member of the chat group.
      function isMember() {
        return request.auth != null && request.auth.uid in resource.data.memberIds;
      }

      // Helper function to check if the user is a member of the chat group for existing documents
      function isExistingMember() {
        return request.auth != null && request.auth.uid in resource.data.memberIds;
      }

      allow get: if isMember();
      allow list: if isMember();
      allow create: if request.auth.uid != null;
      allow update: if isExistingMember();
      allow delete: if isExistingMember();
    }

    /**
     * @description Secures chat messages within a group. Only members of the group can read or write messages.
     * @path /chat_groups/{groupId}/messages/{messageId}
     * @allow (create) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can create a message at /chat_groups/someGroupId/messages/someMessageId if they are a member of the group.
     * @allow (get) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can get a message at /chat_groups/someGroupId/messages/someMessageId if they are a member of the group.
     * @allow (update) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can update a message at /chat_groups/someGroupId/messages/someMessageId if they are a member of the group.
     * @allow (delete) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can delete a message at /chat_groups/someGroupId/messages/someMessageId if they are a member of the group.
     * @deny (create) User 'someOtherUserId' cannot create a message at /chat_groups/someGroupId/messages/someMessageId if they are not a member of the group.
     * @deny (get) User 'someOtherUserId' cannot get a message at /chat_groups/someGroupId/messages/someMessageId if they are not a member of the group.
     * @deny (update) User 'someOtherUserId' cannot update a message at /chat_groups/someGroupId/messages/someMessageId if they are not a member of the group.
     * @deny (delete) User 'someOtherUserId' cannot delete a message at /chat_groups/someGroupId/messages/someMessageId if they are not a member of the group.
     * @principle Inherits authorization from the chat group membership.
     */
    match /chat_groups/{groupId}/messages/{messageId} {
       // Helper function to check if the user is a member of the chat group.
       function isMember() {
            return request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chat_groups/$(groupId)).data.memberIds;
        }

       function isExistingMember() {
            return request.auth != null && request.auth.uid in get(/databases/$(database)/documents/chat_groups/$(groupId)).data.memberIds;
        }

      allow get: if isMember();
      allow list: if isMember();
      allow create: if isMember();
      allow update: if isExistingMember();
      allow delete: if isExistingMember();
    }

    /**
     * @description Secures direct messages between users.  The sender can create, the recipient can read, and either can modify.
     * @path /users/{userId}/private_chats/{chatId}/messages/{messageId}
     * @allow (create) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can create a message at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/private_chats/someChatId/messages/someMessageId.
     * @allow (get) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can get a message at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/private_chats/someChatId/messages/someMessageId if they are the sender or recipient.
     * @allow (update) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can update a message at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/private_chats/someChatId/messages/someMessageId if they are the sender or recipient.
     * @allow (delete) User 'mwSqfH8UgwezVFOWsyNy9d2VQXl1' can delete a message at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/private_chats/someChatId/messages/someMessageId if they are the sender or recipient.
     * @deny (create) User 'someOtherUserId' cannot create a message at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/private_chats/someChatId/messages/someMessageId.
     * @deny (get) User 'someOtherUserId' cannot get a message at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/private_chats/someChatId/messages/someMessageId if they are not the sender or recipient.
     * @deny (update) User 'someOtherUserId' cannot update a message at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/private_chats/someChatId/messages/someMessageId if they are not the sender or recipient.
     * @deny (delete) User 'someOtherUserId' cannot delete a message at /users/mwSqfH8UgwezVFOWsyNy9d2VQXl1/private_chats/someChatId/messages/someMessageId if they are not the sender or recipient.
     * @principle Path-based ownership combined with recipient access.
     */
    match /users/{userId}/private_chats/{chatId}/messages/{messageId} {
      // Helper function to check if the user is the sender or recipient of the message.
      function isSenderOrRecipient(userId) {
        return request.auth != null && (request.auth.uid == userId || request.auth.uid == resource.data.recipientId);
      }

      // Helper function to check if the user is the sender or recipient of the message for existing documents.
      function isExistingSenderOrRecipient(userId) {
        return request.auth != null && (request.auth.uid == userId || request.auth.uid == resource.data.recipientId);
      }

      //Helper function for when document does not exist.
      function isSender(userId) {
          return request.auth != null && request.auth.uid == userId;
      }


      allow get: if isSenderOrRecipient(userId);
      allow list: if isSenderOrRecipient(userId);
      allow create: if request.auth.uid == userId;
      allow update: if isExistingSenderOrRecipient(userId);
      allow delete: if isExistingSenderOrRecipient(userId);
    }

    /**
     * @description Secures affiliate product data. Publicly readable, but only admins can modify.
     * @path /affiliate_products/{productId}
     * @allow (get) Any user can get an affiliate product at /affiliate_products/someProductId.
     * @allow (list) Any user can list affiliate products at /affiliate_products.
     * @allow (create) Only an admin can create an affiliate product at /affiliate_products/someProductId.
     * @allow (update) Only an admin can update an affiliate product at /affiliate_products/someProductId.
     * @allow (delete) Only an admin can delete an affiliate product at /affiliate_products/someProductId.
     * @deny (create) A non-admin user cannot create an affiliate product at /affiliate_products/someProductId.
     * @deny (update) A non-admin user cannot update an affiliate product at /affiliate_products/someProductId.
     * @deny (delete) A non-admin user cannot delete an affiliate product at /affiliate_products/someProductId.
     * @principle Role-based access control.  Requires admin privileges for write operations.
     */
    match /affiliate_products/{productId} {
      // Helper function to check if the user is an admin.
      function isAdmin() {
        return request.auth != null && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
      }

      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin();
      allow delete: if isAdmin();
    }

    /**
     * @description Defines admin roles. The existence of a document grants admin privileges.
     * @path /roles_admin/{userId}
     * @allow (get) Any user can check if a user exists in /roles_admin/{userId}.
     * @allow (list) Listing of all users is disallowed.
     * @allow (create) Only the user with matching userId can create their admin role.
     * @allow (update) Only the user with matching userId can update their admin role.
     * @allow (delete) Only the user with matching userId can delete their admin role.
     * @deny (create) User 'someOtherUserId' cannot create an admin role at /roles_admin/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @deny (get) User 'someOtherUserId' cannot get an admin role at /roles_admin/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @deny (update) User 'someOtherUserId' cannot update an admin role at /roles_admin/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @deny (delete) User 'someOtherUserId' cannot delete an admin role at /roles_admin/mwSqfH8UgwezVFOWsyNy9d2VQXl1.
     * @principle Existence of document grants admin privileges.
     */
    match /roles_admin/{userId} {
      // Reuse the isOwner function defined above.
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
        function isExistingOwner(userId) {
        return isOwner(userId);
      }

      allow get: if true;
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }
  }
}